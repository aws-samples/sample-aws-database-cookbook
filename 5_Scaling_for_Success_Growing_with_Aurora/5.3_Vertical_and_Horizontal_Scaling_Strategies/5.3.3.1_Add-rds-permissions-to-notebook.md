# Adding RDS Permissions to Notebook IAM Role

When working with Aurora clusters from a notebook, you may encounter permission errors like:

```
User: arn:aws:sts::ACCOUNT-ID:assumed-role/NOTEBOOK-ROLE-NAME/SageMaker is not authorized to perform: rds:DescribeDBClusters
```

This guide shows how to add the necessary RDS permissions to your notebook's IAM role.

## Prerequisites

- Access to AWS IAM Console or AWS CLI
- Administrative permissions to modify IAM roles
- Your  notebook role name (found in the error message)

## Method 1: Using AWS Console (Recommended)

### Step 1: Navigate to IAM Console
1. Go to [AWS IAM Console](https://console.aws.amazon.com/iam/)
2. Click on **Roles** in the left sidebar

### Step 2: Find Your Notebook Role
1. Search for your notebook role name (e.g., `AWSNeptuneNotebookRole-*` or similar)
2. Click on the role name to open its details

### Step 3: Add RDS Permissions
1. Click **Add permissions** → **Attach policies**
2. Choose one of the following options:

#### Option A: Use AWS Managed Policy (Quick)
- Search for `AmazonRDSFullAccess`
- Select and attach the policy

#### Option B: Create Custom Policy (Recommended - More Secure)
1. Click **Create policy** instead
2. Select **JSON** tab
3. Paste the following policy:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "rds:DescribeDBClusters",
                "rds:ModifyDBCluster",
                "rds:DescribeDBInstances",
                "rds:ListTagsForResource"
            ],
            "Resource": "*"
        }
    ]
}
```

4. Click **Next: Tags** (optional)
5. Click **Next: Review**
6. Name the policy: `NeptuneNotebook-RDS-Access`
7. Click **Create policy**
8. Go back to your role and attach this new policy

## Method 2: Using AWS CLI

### Step 1: Create Custom Policy
```bash
aws iam create-policy \
    --policy-name NeptuneNotebook-RDS-Access \
    --policy-document '{
        "Version": "2012-10-17",
        "Statement": [
            {
                "Effect": "Allow",
                "Action": [
                    "rds:DescribeDBClusters",
                    "rds:ModifyDBCluster",
                    "rds:DescribeDBInstances",
                    "rds:ListTagsForResource"
                ],
                "Resource": "*"
            }
        ]
    }'
```

### Step 2: Attach Policy to Role
```bash
# Replace YOUR-NOTEBOOK-ROLE-NAME with your actual role name
# Replace YOUR-ACCOUNT-ID with your AWS account ID

aws iam attach-role-policy \
    --role-name YOUR-NOTEBOOK-ROLE-NAME \
    --policy-arn arn:aws:iam::YOUR-ACCOUNT-ID:policy/NeptuneNotebook-RDS-Access
```

## Method 3: Using CloudFormation/CDK

If you're managing infrastructure as code, add this policy to your notebook role:

```yaml
# CloudFormation YAML
NeptuneRDSPolicy:
  Type: AWS::IAM::Policy
  Properties:
    PolicyName: NeptuneNotebook-RDS-Access
    PolicyDocument:
      Version: '2012-10-17'
      Statement:
        - Effect: Allow
          Action:
            - rds:DescribeDBClusters
            - rds:ModifyDBCluster
            - rds:DescribeDBInstances
            - rds:ListTagsForResource
          Resource: '*'
    Roles:
      - !Ref YourNeptuneNotebookRole
```

## Verification

After adding the permissions:

1. **Restart your notebook** (if currently running)
2. **Test the permissions** by running:

```python
import boto3

# Test RDS access
rds = boto3.client('rds')
try:
    response = rds.describe_db_clusters()
    print("✅ RDS permissions working correctly!")
except Exception as e:
    print(f"❌ Still having permission issues: {e}")
```

## Security Best Practices

- **Use custom policies** instead of AWS managed policies when possible
- **Limit resource access** by specifying specific cluster ARNs instead of `"*"`
- **Regular review** of IAM permissions
- **Use least privilege principle** - only grant necessary permissions

## Troubleshooting

### Common Issues:

1. **Policy not taking effect immediately**
   - Wait 1-2 minutes for IAM changes to propagate
   - Restart your notebook session

2. **Still getting permission errors**
   - Verify the policy is attached to the correct role
   - Check if there are any explicit deny policies

3. **Cannot find the role**
   - Look for roles starting with `AWSNeptuneNotebookRole-`
   - Check the error message for the exact role name

### Getting Your Role Name

If you're unsure of your notebook role name, run this in your notebook:

```python
import boto3

# Get current role information
sts = boto3.client('sts')
identity = sts.get_caller_identity()
print(f"Current role ARN: {identity['Arn']}")
```

The role name will be in the ARN after `assumed-role/`.

## Next Steps

Once permissions are added, you can:
- Query Aurora cluster information
- Modify Aurora Serverless scaling configurations
- Monitor RDS metrics and status
- Perform database management tasks from your notebook

---

**Note**: Always follow your organization's security policies when modifying IAM permissions. Consider using temporary credentials or cross-account roles for enhanced security in production environments.